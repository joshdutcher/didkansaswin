<html>
<%- include('head') %>
<body>
    <div id=middle>
        <p id="status" class=""> </p>
        <p id="score"> </p>
        <p id="nav-links"><a href="/about">about</a></p>
    </div>

    <script>
        let isLive = false;

        async function checkStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();

                const statusP = document.getElementById('status');
                const scoreP = document.getElementById('score');

                if (data.isLive && data.liveScore) {
                    // Live game in progress
                    statusP.className = 'notyet';
                    statusP.textContent = 'LIVE';
                    scoreP.textContent = data.liveScore;
                    isLive = true;
                } else if (data.didWin !== null && data.scoreLink) {
                    // Game completed
                    statusP.className = data.didWin ? 'yes' : 'no';
                    statusP.textContent = data.didWin ? 'YES' : 'NO';
                    scoreP.innerHTML = `<a href="${data.scoreLink.url}" target="_blank">${data.scoreLink.text}</a>`;
                    isLive = false;
                } else {
                    // No data available - should not happen with proper server implementation
                    statusP.className = 'notyet';
                    statusP.textContent = '';
                    scoreP.textContent = '';
                    isLive = false;
                }

            } catch (error) {
                console.error('Error fetching status:', error);
                document.getElementById('status').textContent = 'ERROR';
                document.getElementById('score').textContent = '';
            }
        }

        checkStatus();

        // Sync with backend ESPN API calls (every 5 minutes)
        // Poll 30 seconds after the 5-minute mark to get fresh data
        function scheduleNextCheck() {
            const now = new Date();
            const minutesPastHour = now.getMinutes();
            const secondsPastMinute = now.getSeconds();

            // Calculate seconds until next 5-minute mark + 30 seconds
            // (5-minute marks: :00, :05, :10, :15, :20, :25, :30, :35, :40, :45, :50, :55)
            const nextFiveMinuteMark = Math.ceil(minutesPastHour / 5) * 5;
            const targetMinute = nextFiveMinuteMark % 60;
            const targetSecond = 30; // 30 seconds after the ESPN API call

            let msUntilTarget;
            if (minutesPastHour < targetMinute || (minutesPastHour === targetMinute && secondsPastMinute < targetSecond)) {
                // Target is later this hour
                msUntilTarget = ((targetMinute - minutesPastHour) * 60 + (targetSecond - secondsPastMinute)) * 1000;
            } else {
                // Target is next hour or next 5-minute cycle
                const minutesUntilNext = (65 - minutesPastHour + targetMinute) % 60;
                msUntilTarget = (minutesUntilNext * 60 + (targetSecond - secondsPastMinute)) * 1000;
            }

            setTimeout(() => {
                checkStatus();
                // Then continue with regular 5-minute intervals
                setInterval(checkStatus, 5 * 60 * 1000);
            }, msUntilTarget);
        }

        scheduleNextCheck();
    </script>
</body>
</html>